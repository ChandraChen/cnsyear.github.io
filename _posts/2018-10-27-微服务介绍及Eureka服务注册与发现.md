---
title: 微服务介绍及Eureka服务注册与发现
description: 
categories:
 - 微服务
 - Eureka
tags:
 - 微服务
 - Eureka
---
## 微服务介绍及Eureka服务注册与发现
#### 一、服务注册与发现组件Eureka架构介绍

Eureka是Netflix开发的服务发现组件，本身是一个基于REST的服务。Spring Cloud将它集成在其子项目spring-cloud-netflix中，以实现Spring Cloud的服务发现功能

服务发现组件对比（CAP）
- CAP：Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性）
- Zookeeper  - CP
- Eureka  - AP

Eureka 他的源码在github上面：
https://github.com/Netflix/eureka/
他的文档：
https://github.com/Netflix/eureka/wiki
他的架构介绍：High level architecture:
https://github.com/Netflix/eureka/wiki/Eureka-at-a-glance

Eureka High level architecture

![image](http://cnsyear.com/images/blog/TIM截图20181027141602.png)

<!-- more -->

#### 二、实战
##### 1.创建一个EurekaServer

- 加入spring cloud父POM及***spring-cloud-starter-eureka-server***

```
<dependencyManagement>
	<dependencies>
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-dependencies</artifactId>
			<version>Edgware.SR3</version>
			<type>pom</type>
			<scope>import</scope>
		</dependency>
	</dependencies>
</dependencyManagement>

<dependency>
	<groupId>org.springframework.cloud</groupId>
	<artifactId>spring-cloud-starter-eureka-server</artifactId>
</dependency>
```

- Application.properties：

```
server.port=8080
#取消向eureka server(注册中心)注册
eureka.client.register-with-eureka=false
#取消向eureka server(注册中心)获取注册信息
eureka.client.fetch-registry=false

#eureka 提供服务发现的地址
eureka.client.service-url.defaultZone=http://localhost:8080/eureka
```

注意：Eureka本身也是一个服务可以启动的多个做成高可用，我这里就一个取消向注册中心注册

- 启动类增加注解@EnableEurekaServer

```
package com.tuling.springcloud;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;

@SpringBootApplication
@EnableEurekaServer
public class EurekaServerStart {

	public static void main(String[] args) throws Exception {
        SpringApplication.run(EurekaServerStart.class, args);
    }
}

``` 

- 启动访问 http://localhost:8080 即可访问Eureka管理后台

##### 2.创建用户微服务 提供根据id查询用户信息的接口
- 加入spring cloud父POM及***spring-cloud-starter-eureka***

```
<dependencyManagement>
<dependencies>
	<dependency>
		<groupId>org.springframework.cloud</groupId>
		<artifactId>spring-cloud-dependencies</artifactId>
		<version>Edgware.SR3</version>
		<type>pom</type>
		<scope>import</scope>
	</dependency>
</dependencies>
</dependencyManagement>

<!-- eureka -->
<dependency>
	<groupId>org.springframework.cloud</groupId>
	<artifactId>spring-cloud-starter-eureka</artifactId>
</dependency>
```
- Application.properties：

```
spring.application.name=microservice-user
server.port=9091
## eureka
eureka.client.serviceUrl.defaultZone=http://localhost:8080/eureka/
eureka.instance.prefer-ip-address=true
eureka.instance.instance-id=${spring.application.name}:${spring.application.instance_id:${server.port}}
```
- 启动类增加注解@EnableEurekaClient

```
package com.tuling.springcloud;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;

@SpringBootApplication
@EnableDiscoveryClient
//@EnableEurekaClient
public class UserMicroStart {

	public static void main(String[] args) throws Exception {
        SpringApplication.run(UserMicroStart.class, args);
    }
}

```
- 用户查询接口

```
package com.tuling.springcloud.api;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.tuling.springcloud.bean.User;
import com.tuling.springcloud.service.UserService;

@RestController
@RequestMapping("/user")
public class UserController {
	private final Logger logger = LoggerFactory.getLogger(UserController.class);
	
	@Autowired
	private UserService userService;
	
    @RequestMapping("/getById")
    public User getUserById(String id) {
    	logger.debug("param id : {}", id);
        return this.userService.findById(Integer.parseInt(id));
    }
}
```

##### 3.创建订单微服务 调用用户微服务查询用户信息

- 加入spring cloud父POM及spring-cloud-starter-eureka、Application.properties、启动类增加注解@EnableEurekaClient 参考用户微服务配置

- 调用用户服务
```
package com.tuling.springcloud.api;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

@RestController
@RequestMapping("/order")
public class OrderController {
	private final Logger logger = LoggerFactory.getLogger(OrderController.class);
	
	@Autowired
	private RestTemplate restTemplate;

    @RequestMapping("/user/getByIdEureka")
    public Object getUserByIdEureka(String userId) {
    	String url = "http://microservice-user/user/getById?id=" + userId;
    	Object result = restTemplate.getForEntity(url, Object.class);
        return result;
    }
}
```

注意：microservice-user是用户服务的名称

- 增加负载均衡配置

```
@Configuration
public class CommonConfig {
	@Bean
	@LoadBalanced //负载均衡
	public RestTemplate restTemplate() {
	    return new RestTemplate();
	}
}

```


##### 4.为EurekaServer增加安全访问

- EurekaServer中：pom.xml

```
<dependency>
	<groupId>org.springframework.boot</groupId>
	<artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

- EurekaServer中:application.properties

```
#eureka 提供服务发现的地址
eureka.client.service-url.defaultZone=http://zhaojie:12346@localhost:8080/eureka
#eureka.client.service-url.defaultZone=http://localhost:8080/eureka
# 安全模块
security.basic.enabled=true
security.user.name=zhaojie
security.user.password=12346
```

- 用户微服务，订单微服务中： application.properties

```
eureka.client.serviceUrl.defaultZone=http://zhaojie:12346@localhost:123456/eureka
```

##### 全部启动后的运行图

![image](http://cnsyear.com/images/blog/TIM截图20181027163847.png)

*标记： 世间最好的默契，并非有人懂你的言外之意，而是有人懂你的欲言又止。——瑞卡斯*