---
layout: post
title: 微信小程序验证码倒计时60秒提醒功能实现
subtitle: 
date: 2018-04-08
categories: 微信小程序
tags: [微信小程序]
description: 微信小程序验证码倒计时60秒提醒功能实现。
---
#### 微信小程序验证码倒计时60秒提醒功能实现
> 背景 

焙烤小程序有一个获取短信验证码倒计时60秒再次获取的功能。

> 分析

原理和[js验证码倒计时](https://cnsyear.com/2018/02/24/1520094585699.html)是一样的

> 问题

迁移到登陆验证码获取，需要有倒计时功能，app使用到setTimeout ，出问题了？！死活递归调用不了

![image](http://cnsyear.com/images/blog/TIM截图20180408211423.png?1)

> 实现

发现了setInterval倒计时，果然好使。成功运行代码如下

```Html
<!--index.wxml-->
<view class="container">
  <view class="userinfo">
    <button wx:if="{{!hasUserInfo && canIUse}}" open-type="getUserInfo" bindgetuserinfo="getUserInfo"> 获取头像昵称 </button>
    <block wx:else>
      <image bindtap="bindViewTap" class="userinfo-avatar" src="{{userInfo.avatarUrl}}" background-size="cover"></image>
      <text class="userinfo-nickname">{{userInfo.nickName}}</text>
    </block>
  </view>
 <!--验证码按钮 S-->
  <view class="usermotto">
      <button bindtap='sendSms' disabled='{{snsDisabled}}'>{{snsCodeMsg}}</button>
  </view>
   <!--验证码按钮 E-->
</view>

```

```Javascript
//index.js
//获取应用实例
const app = getApp()

Page({
  data: {
    snsCodeMsg: '获取验证码',//默认字
    snsMsgWait:60,//时间秒
    snsDisabled:false,//是否可点击
    userInfo: {},
    hasUserInfo: false,
    canIUse: wx.canIUse('button.open-type.getUserInfo')
  },
  //事件处理函数
  bindViewTap: function() {
    wx.navigateTo({
      url: '../logs/logs'
    })
  },
  onLoad: function () {
    if (app.globalData.userInfo) {
      this.setData({
        userInfo: app.globalData.userInfo,
        hasUserInfo: true
      })
    } else if (this.data.canIUse){
      // 由于 getUserInfo 是网络请求，可能会在 Page.onLoad 之后才返回
      // 所以此处加入 callback 以防止这种情况
      app.userInfoReadyCallback = res => {
        this.setData({
          userInfo: res.userInfo,
          hasUserInfo: true
        })
      }
    } else {
      // 在没有 open-type=getUserInfo 版本的兼容处理
      wx.getUserInfo({
        success: res => {
          app.globalData.userInfo = res.userInfo
          this.setData({
            userInfo: res.userInfo,
            hasUserInfo: true
          })
        }
      })
    }
  },
  getUserInfo: function(e) {
    console.log(e)
    app.globalData.userInfo = e.detail.userInfo
    this.setData({
      userInfo: e.detail.userInfo,
      hasUserInfo: true
    })
  },
  /**
   * 验证码发送
   */
  sendSms:function(){
    // 60秒后重新获取验证码
    var inter = setInterval(function () {
      this.setData({
        snsCodeMsg: "重新发送(" + this.data.snsMsgWait + ")",
        snsMsgWait: this.data.snsMsgWait - 1,
        snsDisabled:true
      });
      if (this.data.snsMsgWait < 0) {
        clearInterval(inter)
        this.setData({
          snsCodeMsg: "获取验证码",
          snsMsgWait: 60,
          snsDisabled: false
        });
      }
    }.bind(this), 1000);
    //注意后面的bind绑定，最关键。不然又是未定义，无法使用外围的变量

  }
})
```

> 运行效果

![image](http://cnsyear.com/images/blog/TIM截图20180408212832.png?1)

[源码地址](https://github.com/cnsyear/tools/tree/master/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/app-djs)
[原文地址](https://yq.aliyun.com/articles/503384)

*标记：1、不要自视清高 ；2、不要盲目承诺； 3、不要轻易求人 ；4、不要强加于人； 5、不要取笑别人； 6、不要信口开河； 7、不要小看仪表； 8、不要乱发脾气 ；9.、不要封闭自己 ；10、不要欺负老实人。
——周立波*